<!DOCTYPE html>
<html>
<head>
    <title>gamepad-vr-azure Client</title>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="three.min.js"></script>
    <script src="StereoEffect.js"></script>
    <script src="DeviceOrientationControls.js"></script>
    <script src="/Scripts/jquery-1.6.4.js"></script>
    <script src="/Scripts/jquery.signalR-2.2.0.js"></script>
    <script src="/signalr/hubs"></script>
    <style>
        body {
            padding: 0;
            margin: 0;
        }
    </style>
</head>
<body>
    <script>

        var container;

        var objects = [];

        var controls;
        var controlsEnabled = false;

        var camera, scene, renderer, effect;

        var mesh, lightMesh, geometry;
        var spheres = [];

        var directionalLight, pointLight;


        var moveLeft, moveRight, moveBackward, moveForward;

        var mouseX = 0, mouseY = 0;

        var windowHalfX = window.innerWidth / 2;
        var windowHalfY = window.innerHeight / 2;


        function init() {

            container = document.createElement('div');
            document.body.appendChild(container);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1000);

            camera.position.set(0, 10, 0);

            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0xffffff, 0, 750);

            var light = new THREE.HemisphereLight(0xeeeeff, 0x777788, 0.75);
            light.position.set(0.5, 1, 0.75);
            scene.add(light);

            // floor

            geometry = new THREE.PlaneGeometry(2000, 2000, 100, 100);
            geometry.applyMatrix(new THREE.Matrix4().makeRotationX(-Math.PI / 2));

            for (var i = 0, l = geometry.vertices.length; i < l; i++) {

                var vertex = geometry.vertices[i];
                vertex.x += Math.random() * 20 - 10;
                vertex.y += Math.random() * 2;
                vertex.z += Math.random() * 20 - 10;

            }

            for (var i = 0, l = geometry.faces.length; i < l; i++) {

                var face = geometry.faces[i];
                face.vertexColors[0] = new THREE.Color().setHSL(Math.random() * 0.3 + 0.5, 0.75, Math.random() * 0.25 + 0.75);
                face.vertexColors[1] = new THREE.Color().setHSL(Math.random() * 0.3 + 0.5, 0.75, Math.random() * 0.25 + 0.75);
                face.vertexColors[2] = new THREE.Color().setHSL(Math.random() * 0.3 + 0.5, 0.75, Math.random() * 0.25 + 0.75);

            }

            material = new THREE.MeshBasicMaterial({ vertexColors: THREE.VertexColors });

            mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);

            // objects

            geometry = new THREE.BoxGeometry(20, 20, 20);

            for (var i = 0, l = geometry.faces.length; i < l; i++) {

                var face = geometry.faces[i];
                face.vertexColors[0] = new THREE.Color().setHSL(Math.random() * 0.3 + 0.5, 0.75, Math.random() * 0.25 + 0.75);
                face.vertexColors[1] = new THREE.Color().setHSL(Math.random() * 0.3 + 0.5, 0.75, Math.random() * 0.25 + 0.75);
                face.vertexColors[2] = new THREE.Color().setHSL(Math.random() * 0.3 + 0.5, 0.75, Math.random() * 0.25 + 0.75);

            }

            for (var i = 0; i < 500; i++) {

                material = new THREE.MeshPhongMaterial({ specular: 0xffffff, shading: THREE.FlatShading, vertexColors: THREE.VertexColors });

                var mesh = new THREE.Mesh(geometry, material);
                mesh.position.x = Math.floor(Math.random() * 20 - 10) * 20;
                mesh.position.y = Math.floor(Math.random() * 20) * 20 + 10;
                mesh.position.z = Math.floor(Math.random() * 20 - 10) * 20;
                scene.add(mesh);

                material.color.setHSL(Math.random() * 0.2 + 0.5, 0.75, Math.random() * 0.25 + 0.75);

                objects.push(mesh);

            }

            //

            //

            renderer = new THREE.WebGLRenderer();
            renderer.setClearColor(0xffffff);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            effect = new THREE.StereoEffect(renderer);
            effect.eyeSeparation = 4;
            effect.setSize(window.innerWidth, window.innerHeight);

            //

            window.addEventListener('resize', onWindowResize, false);

        }

        function onWindowResize() {

            windowHalfX = window.innerWidth / 2,
            windowHalfY = window.innerHeight / 2,

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            effect.setSize(window.innerWidth, window.innerHeight);

        }

        function onDocumentMouseMove(event) {

            mouseX = (event.clientX - windowHalfX) * 10;
            mouseY = (event.clientY - windowHalfY) * 10;

        }

        //

        function animate() {

            requestAnimationFrame(animate);

            render();

        }

        function render() {

            var timer = 0.0001 * Date.now();

            if (controlsEnabled) {
                controls.update();
            }

            if (moveForward) {
                camera.position.z -= 2;
            }
            if (moveBackward) {
                camera.position.z += 2;
            }
            if (moveLeft) {
                camera.position.x -= 2;
            }
            if (moveRight) {
                camera.position.x += 2;
            }

            effect.render(scene, camera);

        }



        function setOrientationControls(e) {
            if (!e.alpha) {
                return;
            }

            controls = new THREE.DeviceOrientationControls(camera, true);
            controls.connect();
            controls.update();

            controlsEnabled = true;

            window.removeEventListener('deviceorientation', setOrientationControls, true);
        }
        window.addEventListener('deviceorientation', setOrientationControls, true);


        init();
        animate();

        //Connect to Azure and recieve input

        var chat;
        $(function () {
            chat = $.connection.gameHub;
            chat.client.broadcastMessage = function (name, message) {
                if (name == 'server') {
                    if (message == 'up') {
                        moveForward = true;
                        moveBackward = false;
                    }
                    if (message == 'down') {
                        moveBackward = true;
                        moveForward = false;
                    }
                    if (message == 'left') {
                        moveLeft = true;
                        moveRight = false;
                    }
                    if (message == 'right') {
                        moveRight = true;
                        moveLeft = false;
                    }
                    if (message == '_up') {
                        moveForward = false;
                    }
                    if (message == '_down') {
                        moveBackward = false;
                    }
                    if (message == '_left') {
                        moveLeft = false;
                    }
                    if (message == '_right') {
                        moveRight = false;
                    }
                }
                //if (name == 'server_mouse_x') {
                //    controls.getObject().rotation.y -= parseFloat(message);
                //}
                //if (name == 'server_mouse_y') {
                //    controls.getObject2().rotation.x -= parseFloat(message);
                //    //controls.getObject2().rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, controls.getObject2().rotation.x));
                //}
            };
            $.connection.hub.start({ transport: 'longPolling' }).done(function () {
                //do something later
            });
        });

    </script>
</body>
</html>
